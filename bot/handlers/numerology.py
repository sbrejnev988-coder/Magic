"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏
"""

from aiogram import Router, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder
from datetime import datetime

router = Router()


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
class NumerologyCalculation(StatesGroup):
    waiting_for_birthdate = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è


@router.message(Command("numerology"))
async def cmd_numerology(message: Message, state: FSMContext):
    """–ö–æ–º–∞–Ω–¥–∞ /numerology - –Ω–∞—á–∞–ª–æ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞"""
    await state.set_state(NumerologyCalculation.waiting_for_birthdate)
    
    text = """
üî¢ *–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è ‚Äî –Ω–∞—É–∫–∞ –æ —á–∏—Å–ª–∞—Ö —Å—É–¥—å–±—ã*

–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ *–î–î.–ú–ú.–ì–ì–ì–ì*

*–ü—Ä–∏–º–µ—Ä:* 15.09.1990

–ü–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è —è —Ä–∞—Å—Å—á–∏—Ç–∞—é:
‚Ä¢ *–ß–∏—Å–ª–æ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ü—É—Ç–∏* ‚Äî –≤–∞—à–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
‚Ä¢ *–ß–∏—Å–ª–æ –°—É–¥—å–±—ã* ‚Äî –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
‚Ä¢ *–ß–∏—Å–ª–æ –°–µ—Ä–¥—Ü–∞* ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è
‚Ä¢ *–ß–∏—Å–ª–æ –õ–∏—á–Ω–æ—Å—Ç–∏* ‚Äî –∫–∞–∫ –≤–∞—Å –≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ
‚Ä¢ *–ß–∏—Å–ª–æ –≠–∫—Å–ø—Ä–µ—Å—Å–∏–∏* ‚Äî –≤–∞—à–∏ —Ç–∞–ª–∞–Ω—Ç—ã
"""
    
    await message.answer(text, parse_mode="Markdown")


@router.message(NumerologyCalculation.waiting_for_birthdate)
async def process_birthdate(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –∏ —Ä–∞—Å—á—ë—Ç —á–∏—Å–µ–ª"""
    birthdate_str = message.text.strip()
    
    try:
        # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
        birthdate = datetime.strptime(birthdate_str, "%d.%m.%Y")
        today = datetime.now()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
        if birthdate > today:
            await message.answer("–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            return
        
        # –†–∞—Å—á—ë—Ç —á–∏—Å–µ–ª (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)
        day = birthdate.day
        month = birthdate.month
        year = birthdate.year
        
        # –ß–∏—Å–ª–æ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ü—É—Ç–∏
        life_path = sum(int(d) for d in str(day) + str(month) + str(year))
        while life_path > 9 and life_path not in [11, 22, 33]:
            life_path = sum(int(d) for d in str(life_path))
        
        # –ß–∏—Å–ª–æ –°—É–¥—å–±—ã (–ø–æ –ø–æ–ª–Ω–æ–π –¥–∞—Ç–µ)
        destiny = sum(int(d) for d in birthdate_str if d.isdigit())
        while destiny > 9 and destiny not in [11, 22, 33]:
            destiny = sum(int(d) for d in str(destiny))
        
        # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —á–∏—Å–µ–ª
        meanings = {
            1: "–õ–∏–¥–µ—Ä, –Ω–æ–≤–∞—Ç–æ—Ä, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å",
            2: "–î–∏–ø–ª–æ–º–∞—Ç, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
            3: "–¢–≤–æ—Ä–µ—Ü, –æ–ø—Ç–∏–º–∏–∑–º, —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ",
            4: "–°—Ç—Ä–æ–∏—Ç–µ–ª—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å",
            5: "–°–≤–æ–±–æ–¥–Ω—ã–π –¥—É—Ö, –ø–µ—Ä–µ–º–µ–Ω—ã, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
            6: "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π, –≥–∞—Ä–º–æ–Ω–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
            7: "–ú—É–¥—Ä–µ—Ü, –∞–Ω–∞–ª–∏–∑, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å",
            8: "–ú–∞—Ç–µ—Ä–∏–∞–ª–∏—Å—Ç, —É—Å–ø–µ—Ö, –≤–ª–∞—Å—Ç—å",
            9: "–ì—É–º–∞–Ω–∏—Å—Ç, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ",
            11: "–ü—Ä–æ—Å–≤–µ—Ç–∏—Ç–µ–ª—å, –∏–Ω—Ç—É–∏—Ü–∏—è, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ",
            22: "–°—Ç—Ä–æ–∏—Ç–µ–ª—å –º–∏—Ä–∞, –º–∞—Å—Ç–µ—Ä, –≥—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã–µ –ø–ª–∞–Ω—ã",
            33: "–£—á–∏—Ç–µ–ª—å —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞, —Å–ª—É–∂–µ–Ω–∏–µ, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ"
        }
        
        life_path_meaning = meanings.get(life_path, "–û—Å–æ–±–æ–µ —á–∏—Å–ª–æ")
        destiny_meaning = meanings.get(destiny, "–û—Å–æ–±–æ–µ —á–∏—Å–ª–æ")
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
        report = f"""
üìä *–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç*

*–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:* {birthdate.strftime('%d.%m.%Y')}
*–í–æ–∑—Ä–∞—Å—Ç:* {today.year - birthdate.year} –ª–µ—Ç

üîÆ *–ß–∏—Å–ª–æ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ü—É—Ç–∏:* {life_path}
*–ó–Ω–∞—á–µ–Ω–∏–µ:* {life_path_meaning}

–≠—Ç–æ –≤–∞—à–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—à –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –ø—É—Ç—å, —Ç–∞–ª–∞–Ω—Ç—ã –∏ –≤—ã–∑–æ–≤—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã —Å—Ç–æ–ª–∫–Ω—ë—Ç–µ—Å—å.

üåü *–ß–∏—Å–ª–æ –°—É–¥—å–±—ã (–í—ã—Ä–∞–∂–µ–Ω–∏—è):* {destiny}
*–ó–Ω–∞—á–µ–Ω–∏–µ:* {destiny_meaning}

–≠—Ç–æ —á–∏—Å–ª–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ –≤—Ä–æ–∂–¥—ë–Ω–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —Ç–æ, —á—Ç–æ –≤—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–∑–≤–∏–≤–∞—Ç—å –≤ —ç—Ç–æ–π –∂–∏–∑–Ω–∏.

üìà *–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —á–∏—Å–µ–ª:*
–í–∞—à–∏ —á–∏—Å–ª–∞ {life_path} –∏ {destiny} {"–≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è" if abs(life_path - destiny) <= 3 else "—Ç—Ä–µ–±—É—é—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏"}.

üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
1. –†–∞–∑–≤–∏–≤–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∞—à–µ–≥–æ –ß–∏—Å–ª–∞ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ü—É—Ç–∏
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–ª–∞–Ω—Ç—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –ß–∏—Å–ª–µ –°—É–¥—å–±—ã
3. –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤–∞—à–∏ —á–∏—Å–ª–∞

‚ú® *–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç:*
–ö–∞–∂–¥—ã–π –¥–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –∫—Ä–∞—Ç–µ–Ω {life_path}, –±—É–¥–µ—Ç –¥–ª—è –≤–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ —É–¥–∞—á–Ω—ã–º –¥–ª—è –Ω–∞—á–∏–Ω–∞–Ω–∏–π.
"""
        
        await state.clear()
        await message.answer(report, parse_mode="Markdown")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
        builder = InlineKeyboardBuilder()
        builder.row(types.InlineKeyboardButton(text="üìÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º", callback_data="numerology_compat"))
        builder.row(types.InlineKeyboardButton(text="üí∞ –ß–∏—Å–ª–æ –±–æ–≥–∞—Ç—Å—Ç–≤–∞", callback_data="numerology_wealth"))
        builder.row(types.InlineKeyboardButton(text="üíù –ß–∏—Å–ª–æ –ª—é–±–≤–∏", callback_data="numerology_love"))
        
        await message.answer("–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?", reply_markup=builder.as_markup())
        
    except ValueError:
        await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ *–î–î.–ú–ú.–ì–ì–ì–ì*", parse_mode="Markdown")


@router.callback_query(lambda c: c.data.startswith("numerology_"))
async def process_numerology_extras(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    option = callback.data
    
    if option == "numerology_compat":
        text = "–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì"
    elif option == "numerology_wealth":
        text = "üîÆ *–ß–∏—Å–ª–æ –±–æ–≥–∞—Ç—Å—Ç–≤–∞* —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –∏–º–µ–Ω–∏. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û):"
    elif option == "numerology_love":
        text = "üíñ *–ß–∏—Å–ª–æ –ª—é–±–≤–∏* –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ –ª—é–±–æ–≤–Ω—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±–æ–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤:"
    else:
        text = "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é."
    
    await callback.message.answer(text, parse_mode="Markdown")
    await callback.answer()