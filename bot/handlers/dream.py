"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å–Ω–æ–≤
"""

import logging
import random
from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder

router = Router()
log = logging.getLogger(__name__)


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å–Ω–æ–≤
class DreamInterpretation(StatesGroup):
    waiting_for_dream = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å–Ω–∞


@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"""
    current_state = await state.get_state()
    if current_state is None:
        await message.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        return
    
    await state.clear()
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.", parse_mode="Markdown")


@router.message(Command("dream"))
async def cmd_dream(message: Message, state: FSMContext):
    """–ö–æ–º–∞–Ω–¥–∞ /dream - –Ω–∞—á–∞–ª–æ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å–Ω–∞"""
    await state.set_state(DreamInterpretation.waiting_for_dream)
    
    text = """
üìñ *–°–æ–Ω–Ω–∏–∫ ‚Äî —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–Ω–æ–≤*

–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Å–æ–Ω –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –∏ —è –ø–æ–º–æ–≥—É –µ–≥–æ —Ä–∞—Å—Ç–æ–ª–∫–æ–≤–∞—Ç—å.

*–ü—Ä–∏–º–µ—Ä—ã:*
‚Ä¢ "–ú–Ω–µ –ø—Ä–∏—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ —è –ª–µ—Ç–∞—é –Ω–∞–¥ –≥–æ—Ä–æ–¥–æ–º"
‚Ä¢ "–ü—Ä–∏—Å–Ω–∏–ª–∞—Å—å –∑–º–µ—è, –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è –ø—Ä–µ—Å–ª–µ–¥—É–µ—Ç"
‚Ä¢ "–°–Ω–∏–ª–æ—Å—å, —á—Ç–æ —è –ø–æ—Ç–µ—Ä—è–ª –∫–æ—à–µ–ª—ë–∫"

–ß–µ–º –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π, —Ç–µ–º —Ç–æ—á–Ω–µ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ.

*–°–æ–≤–µ—Ç:* –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–Ω—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è.

–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à —Å–æ–Ω:
"""
    
    await message.answer(text, parse_mode="Markdown")


@router.message(DreamInterpretation.waiting_for_dream)
async def process_dream(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Å–Ω–∞"""
    dream_text = message.text.strip()
    user_id = message.from_user.id
    
    log.info(f"Dream interpretation request from {user_id}")
    
    # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–∞ —á–µ—Ä–µ–∑ LLM
    # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ–º
    
    dream_keywords = ["–ª–µ—Ç–∞—Ç—å", "–∑–º–µ—è", "–≤–æ–¥–∞", "–¥–µ–Ω—å–≥–∏", "–ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "–ø–∞–¥–µ–Ω–∏–µ", "—Å–º–µ—Ä—Ç—å", "—Å–≤–∞–¥—å–±–∞", "—Ä–µ–±—ë–Ω–æ–∫", "–¥–æ–º"]
    matched_keywords = [kw for kw in dream_keywords if kw in dream_text.lower()]
    
    interpretations = [
        "–õ–µ—Ç–∞—Ç—å –≤–æ —Å–Ω–µ ‚Äî –∫ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—é –æ—Ç –ø—Ä–æ–±–ª–µ–º –∏ –Ω–æ–≤—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º.",
        "–ó–º–µ—è —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–∞—Ö–∏ –∏–ª–∏ –º—É–¥—Ä–æ—Å—Ç—å. –í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º –Ω—É–∂–Ω–æ –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ.",
        "–í–æ–¥–∞ –≤–æ —Å–Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å —ç–º–æ—Ü–∏—è–º–∏. –ß–∏—Å—Ç–∞—è –≤–æ–¥–∞ ‚Äî –∫ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—é, –º—É—Ç–Ω–∞—è ‚Äî –∫ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏.",
        "–î–µ–Ω—å–≥–∏ –≤–æ —Å–Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç –≤–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–º—É –º–∏—Ä—É. –ü–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ ‚Äî –∫ –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤—É –æ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö.",
        "–ü—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã –∏–∑–±–µ–≥–∞–µ—Ç–µ —á–µ–≥–æ-—Ç–æ –≤–∞–∂–Ω–æ–≥–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏.",
        "–ü–∞–¥–µ–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç –æ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–ª–∏ —Å—Ç—Ä–∞—Ö–µ –Ω–µ—É–¥–∞—á–∏.",
        "–°–º–µ—Ä—Ç—å –≤–æ —Å–Ω–µ ‚Äî –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —ç—Ç–∞–ø–∞ –∏ –Ω–æ–≤–æ–º—É –Ω–∞—á–∞–ª—É.",
        "–°–≤–∞–¥—å–±–∞ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—é–∑ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç–µ–π –∏–ª–∏ –≤–∞–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.",
        "–†–µ–±—ë–Ω–æ–∫ –≤–æ —Å–Ω–µ ‚Äî –∫ –Ω–æ–≤—ã–º –∏–¥–µ—è–º –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞–º.",
        "–î–æ–º –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤–∞—à–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –£—é—Ç–Ω—ã–π –¥–æ–º ‚Äî –∫ –≥–∞—Ä–º–æ–Ω–∏–∏, —Ä–∞–∑—Ä—É—à–µ–Ω–Ω—ã–π ‚Äî –∫ —Ç—Ä–µ–≤–æ–≥–µ."
    ]
    
    if matched_keywords:
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–æ–≤–ø–∞–≤—à–µ–º—É –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É
        keyword = matched_keywords[0]
        index = dream_keywords.index(keyword)
        interpretation = interpretations[index]
    else:
        interpretation = random.choice(interpretations)
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    response = f"""
üîÆ *–¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–Ω–∞*

*–í–∞—à —Å–æ–Ω:* {dream_text[:200]}...

*–û—Å–Ω–æ–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:*
{interpretation}

*–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:*
–°–æ–Ω –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å –≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è –∏–ª–∏ –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
1. –ó–∞–¥—É–º–∞–π—Ç–µ—Å—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —É –≤–∞—Å –ø–æ—Ö–æ–∂–∏–µ —ç–º–æ—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏
2. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–µ—Ç–∞–ª–∏ —Å–Ω–∞ ‚Äî –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
3. –ù–µ –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±—É–∫–≤–∞–ª—å–Ω–æ

‚ú® *–°–æ–Ω ‚Äî —ç—Ç–æ –∑–µ—Ä–∫–∞–ª–æ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è.*
"""
    
    await state.clear()
    await message.answer(response, parse_mode="Markdown")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="üìö –°–æ–Ω–Ω–∏–∫ –ø–æ —Å–∏–º–≤–æ–ª–∞–º", callback_data="dream_symbols"))
    builder.row(types.InlineKeyboardButton(text="üí§ –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–Ω–æ–≤", callback_data="dream_recurring"))
    builder.row(types.InlineKeyboardButton(text="üîÆ –ù–æ–≤—ã–π —Å–æ–Ω", callback_data="dream_new"))
    
    await message.answer("–ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=builder.as_markup())


@router.callback_query(lambda c: c.data.startswith("dream_"))
async def process_dream_extras(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π —Å–æ–Ω–Ω–∏–∫–∞"""
    option = callback.data
    
    if option == "dream_symbols":
        text = """
üìö *–°–æ–Ω–Ω–∏–∫ –ø–æ —Å–∏–º–≤–æ–ª–∞–º*

*–ß–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è:*

*–ñ–∏–≤–æ—Ç–Ω—ã–µ:*
‚Ä¢ **–ö–æ—à–∫–∞** ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –∏–Ω—Ç—É–∏—Ü–∏—è
‚Ä¢ **–°–æ–±–∞–∫–∞** ‚Äî –≤–µ—Ä–Ω–æ—Å—Ç—å, –¥—Ä—É–∂–±–∞
‚Ä¢ **–ü—Ç–∏—Ü–∞** ‚Äî —Å–≤–æ–±–æ–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ

*–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è:*
‚Ä¢ **–î–æ–∂–¥—å** ‚Äî –æ—á–∏—â–µ–Ω–∏–µ, —ç–º–æ—Ü–∏–∏
‚Ä¢ **–°–æ–ª–Ω—Ü–µ** ‚Äî —ç–Ω–µ—Ä–≥–∏—è, —É—Å–ø–µ—Ö
‚Ä¢ **–ì—Ä–æ–∑–∞** ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –ø–µ—Ä–µ–º–µ–Ω—ã

*–ü—Ä–µ–¥–º–µ—Ç—ã:*
‚Ä¢ **–ö–ª—é—á** ‚Äî –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
‚Ä¢ **–ó–µ—Ä–∫–∞–ª–æ** ‚Äî —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏—è
‚Ä¢ **–ö–Ω–∏–≥–∞** ‚Äî –∑–Ω–∞–Ω–∏—è, —Å–µ–∫—Ä–µ—Ç—ã

*–î–µ–π—Å—Ç–≤–∏—è:*
‚Ä¢ **–ë–µ–≥** ‚Äî —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
‚Ä¢ **–ü–∞–¥–µ–Ω–∏–µ** ‚Äî —Å—Ç—Ä–∞—Ö –Ω–µ—É–¥–∞—á–∏
‚Ä¢ **–ü–æ–ª–µ—Ç** ‚Äî –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ

–î–ª—è —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ.
"""
    elif option == "dream_recurring":
        text = """
üí§ *–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–Ω—ã*

–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–Ω—ã –æ–±—ã—á–Ω–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–µ—Ä–µ—à—ë–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è.

*–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*
1. **–ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –¥–µ–ª–∞** ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–∞—à–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è
2. **–ü–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏** ‚Äî —Å—Ç—Ä–∞—Ö, –≥–Ω–µ–≤, –æ–±–∏–¥–∞
3. **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç** ‚Äî –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –∂–µ–ª–∞–Ω–∏—è
4. **–¢—Ä–∞–≤–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–ø—ã—Ç** ‚Äî —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏

*–ß—Ç–æ –¥–µ–ª–∞—Ç—å:*
1. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–Ω—ã –≤ –¥–µ—Ç–∞–ª—è—Ö
2. –ò—â–∏—Ç–µ –æ–±—â–∏–µ —Ç–µ–º—ã –∏ —ç–º–æ—Ü–∏–∏
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–Ω–∞ –≤ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–∏
4. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º

*–ü—Ä–∏–º–µ—Ä:* –ï—Å–ª–∏ –≤–∞–º —á–∞—Å—Ç–æ —Å–Ω–∏—Ç—Å—è –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, —Å–ø—Ä–æ—Å–∏—Ç–µ —Å–µ–±—è: ¬´–ß—Ç–æ —è –∏–∑–±–µ–≥–∞—é –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏?¬ª
"""
    elif option == "dream_new":
        text = "üìñ –û–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–π —Å–æ–Ω –¥–ª—è —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è."
        await callback.message.answer(text, parse_mode="Markdown")
        await callback.answer()
        return
    
    await callback.message.answer(text, parse_mode="Markdown")
    await callback.answer()


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ start.py